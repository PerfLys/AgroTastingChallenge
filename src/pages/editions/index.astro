---
import Layout from "@/layouts/Layout.astro";
import PageHeader from "@/components/elements/PageHeader.astro";
import { getCollection } from "astro:content";
import EditionCard from "@/components/editions/EditionCard.astro";
import { formatEditionSentence } from "@/utils/editionDates";

const editions = (await getCollection("edition"))
    .slice()
    .sort((a, b) => (b.data.year ?? 0) - (a.data.year ?? 0));

const editionCards = await Promise.all(
    editions.map(async (e) => {
        const year = e.data.year;
        const cmsPhotos = (Array.isArray(e.data.photos) ? e.data.photos : []).filter(Boolean);
        const coverImage = e.data.coverImage || cmsPhotos[0];
        const dateSubtitle = formatEditionSentence(
            year,
            { startDate: e.data.startDate, endDate: e.data.endDate },
            "fr-FR",
        );
        const subtitle =
            dateSubtitle ||
            e.data.description ||
            (coverImage ? "Galerie photos" : "PDFs (photos à venir)");
        return { year, coverImage, subtitle };
    }),
);
---

<Layout title="Éditions">
    <div class="site-container mx-auto px-4 mt-10">
        <PageHeader
            title="Éditions"
            description="Retrouvez les photos et documents de chaque édition."
        />

        <div class="inner-container mx-auto">
            <section
                class="rounded-3xl border border-dashed border-neutral-200 dark:border-neutral-700 bg-white/70 dark:bg-neutral-950/30 backdrop-blur-sm p-6 sm:p-8"
            >
                {
                    editions.length === 0 ? (
                        <p class="text-sm leading-7 text-neutral-700 dark:text-neutral-300">
                            Aucune édition n’est publiée pour le moment.
                        </p>
                    ) : (
                        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {editionCards.map((card, idx) => (
                                <EditionCard
                                    year={card.year}
                                    href={`/editions/${card.year}`}
                                    subtitle={card.subtitle}
                                    coverImage={card.coverImage}
                                    isAboveFold={idx < 2}
                                />
                            ))}
                        </div>
                    )
                }
            </section>
        </div>
    </div>
</Layout>
