---
import { ChevronDown } from "@lucide/astro";
import menus from "@/collections/menu.json";
import menusEn from "@/collections/menu.en.json";
import Button from "@/components/ui/Button.astro";
import Logo from "@/components/ui/Logo.astro";

const pathname = Astro.url?.pathname ?? "/";
const isEn = pathname === "/en" || pathname.startsWith("/en/");
const activeMenus = isEn ? menusEn : menus;

const switchHref = isEn
  ? (pathname === "/en" || pathname === "/en/" ? "/" : pathname.replace(/^\/en/, "") || "/")
  : (pathname === "/" ? "/en/" : `/en${pathname}`);
---

<!-- This is an invisible div with relative position so that it takes up the height of the menu (because menu is absolute/fixed) -->
<div class="relative w-full h-16 sm:h-20 opacity-0 pointer-events-none"></div>
<header id="header" class="fixed top-2 sm:top-4 z-50 w-full px-3 sm:px-4 lg:px-6">
  <div id="site-container"
    class="flex items-center justify-between h-14 sm:h-15 site-container mx-auto px-4 sm:px-6 py-2.5 border-transparent border-[0.5px] transition-all duration-300"
  >
    <!-- Logo -->
    <div class="flex-shrink-0 z-50">
      <Logo />
    </div>

    <!-- Mobile Menu Background Overlay -->
    <div
      id="mobileMenuBackground"
      class="fixed inset-0 z-20 hidden w-screen h-screen duration-300 ease-out bg-white/90 backdrop-blur-sm dark:bg-neutral-950/90"
    >
    </div>

    <!-- Navigation -->
    <nav
      class="relative z-30 flex flex-row-reverse justify-start w-full text-sm sm:justify-end text-neutral-500 dark:text-neutral-400 sm:flex-row sm:items-center"
    >
      <!-- Mobile Menu Toggle Buttons -->
      <div class="flex items-center gap-2 sm:hidden">
        <!-- Language Toggle (Mobile) -->
        <a
          href={switchHref}
          class="flex items-center justify-center h-10 px-3 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white/60 dark:bg-neutral-950/30 backdrop-blur-sm text-xs text-neutral-700 dark:text-neutral-200 hover:border-primary/30 hover:text-primary transition-colors active:scale-95"
          aria-label={isEn ? "Switch language to French" : "Switch language to English"}
          title={isEn ? "Langue : Français" : "Language: English"}
        >
          <span class="opacity-70">{isEn ? "Langue" : "Language"}</span>
          <span class="mx-1 opacity-40">:</span>
          <span class="font-medium">{isEn ? "FR" : "EN"}</span>
        </a>

        <!-- Hamburger Menu Button -->
        <div
          id="openMenu"
          class="flex items-center justify-center w-10 h-10 cursor-pointer transition-transform duration-200 active:scale-90"
        >
          <svg
            class="w-7 h-7 text-neutral-700 dark:text-neutral-200"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            viewBox="0 0 24 24"
            stroke="currentColor"><path d="M4 8h16M4 16h16"></path></svg
          >
        </div>

        <!-- Close Menu Button -->
        <div
          id="closeMenu"
          class="hidden items-center justify-center w-10 h-10 cursor-pointer transition-transform duration-200 active:scale-90"
        >
          <svg
            class="w-6 h-6 text-neutral-600 dark:text-neutral-200"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            viewBox="0 0 24 24"
            stroke="currentColor"><path d="M6 18L18 6M6 6l12 12"></path></svg
          >
        </div>
      </div>

      <!-- Menu Items -->
      <div
        id="menu"
        class="fixed top-[68px] sm:top-0 left-3 right-3 sm:left-0 sm:right-0 ease-out duration-300 z-40 flex-col items-center justify-start hidden w-auto h-auto text-sm pt-6 pb-5 sm:py-0 sm:relative sm:flex-row sm:flex"
      >
        <!-- Mobile Menu Background -->
        <div
          class="absolute inset-0 top-0 right-0 block w-full h-full sm:hidden"
        >
          <div
            class="relative w-full h-full bg-white/95 border border-dashed border-neutral-300 dark:border-neutral-700 backdrop-blur-md rounded-2xl dark:bg-neutral-950/95 shadow-lg"
          >
          </div>
        </div>

        <!-- Menu Links -->
        <div class="relative z-10 flex flex-col sm:flex-row items-center w-full sm:w-auto gap-1 sm:gap-0">
          {activeMenus.map((menu) => {
            const hasChildren = Array.isArray(menu.children) && menu.children.length > 0;
            const children = Array.isArray(menu.children) ? menu.children : [];

            if (!hasChildren) {
              return (
                <a
                  href={menu.url}
                  class="relative flex items-center justify-center w-full sm:w-auto px-5 py-2.5 sm:py-2 sm:px-3 md:px-4 font-medium tracking-wide text-center duration-200 ease-out rounded-lg sm:rounded-none text-neutral-700 dark:text-neutral-200 hover:text-primary sm:hover:bg-transparent dark:hover:text-white dark:hover:bg-neutral-800/50 sm:dark:hover:bg-transparent active:scale-[0.98] sm:active:scale-100 transition-all"
                >
                  {menu.name}
                </a>
              );
            }

            return (
              <>
                {/* Mobile: collapsible section */}
                <details class="w-full sm:hidden">
                  <summary class="list-none cursor-pointer relative flex items-center justify-between w-full px-5 py-2.5 font-medium tracking-wide rounded-lg text-neutral-700 dark:text-neutral-200 hover:text-primary dark:hover:text-white hover:bg-neutral-100/40 dark:hover:bg-neutral-800/40 transition-all">
                    <span class="flex items-center gap-2">
                      <span>{menu.name}</span>
                    </span>
                    <ChevronDown class="w-4 h-4 opacity-70" />
                  </summary>
                  <div class="mt-1 mb-1 px-3">
                    <div class="rounded-xl border border-dashed border-neutral-300 dark:border-neutral-700 bg-white/70 dark:bg-neutral-950/40 overflow-hidden">
                      {children.map((child) => (
                        <a
                          href={child.url}
                          class="block px-4 py-3 text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100/60 dark:hover:bg-neutral-800/40 border-t border-dashed border-neutral-200 dark:border-neutral-800"
                        >
                          {child.name}
                        </a>
                      ))}
                    </div>
                  </div>
                </details>

                {/* Desktop: hover dropdown */}
                <div class="relative hidden sm:block group">
                  <a
                    href={menu.url}
                    class="relative inline-flex items-center justify-center px-3 md:px-4 py-2 font-medium tracking-wide text-center duration-200 ease-out rounded-none text-neutral-700 dark:text-neutral-200 hover:text-primary dark:hover:text-white transition-all"
                  >
                    {menu.name}
                    <ChevronDown class="ml-1 w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" />
                  </a>

                  <div class="absolute left-1/2 -translate-x-1/2 top-full pt-2 hidden group-hover:block">
                    <div class="min-w-[220px] rounded-2xl border border-dashed border-neutral-300 dark:border-neutral-700 bg-white/95 dark:bg-neutral-950/95 backdrop-blur-md shadow-lg overflow-hidden">
                      {children.map((child) => (
                        <a
                          href={child.url}
                          class="block px-4 py-3 text-sm text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100/60 dark:hover:bg-neutral-800/40 border-t border-dashed border-neutral-200 dark:border-neutral-800"
                        >
                          {child.name}
                        </a>
                      ))}
                    </div>
                  </div>
                </div>
              </>
            );
          })}
        </div>
      </div>

      <!-- Desktop Actions -->
      <div class="relative hidden sm:flex items-center gap-2 ml-4 lg:ml-6">
        <Button
          url={switchHref}
          type="solid"
          size="xs"
          className="md:flex mx-1 max-w-none hover:shadow-none hover:-translate-y-0"
        >
          <span class="opacity-70">{isEn ? "Langue" : "Language"}:</span>
          <span class="ml-1">{isEn ? "Français" : "English"}</span>
        </Button>
      </div>
    </nav>
  </div>
</header>

<style>
  /* Header container spacing optimization */
  #header {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Ensure mobile menu doesn't stick to edges */
  @media (max-width: 639px) {
    #menu {
      max-width: calc(100vw - 24px); /* 12px margin on each side */
    }
  }

  /* Mobile menu animation */
  @media (max-width: 639px) {
    #menu {
      transform: translateY(-10px);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    #menu:not(.hidden) {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
  }

  /* Menu item hover effect optimization */
  nav a {
    position: relative;
  }

  /* Desktop underline animation */
  @media (min-width: 640px) {
    nav a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 70%;
      height: 2px;
      background: var(--color-primary);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px;
    }

    nav a:hover::after {
      transform: translateX(-50%) scaleX(1);
    }
  }

  /* Mobile menu item click feedback */
  @media (max-width: 639px) {
    nav a:active {
      background-color: var(--color-neutral-100);
    }

    .dark nav a:active {
      background-color: rgba(255, 255, 255, 0.05);
    }
  }


  /* Mobile menu background blur effect enhancement */
  @supports (backdrop-filter: blur(12px)) {
    #mobileMenuBackground {
      backdrop-filter: blur(12px);
    }

    @media (max-width: 639px) {
      #menu > div > div {
        backdrop-filter: blur(16px);
      }
    }
  }

  /* Ensure Logo doesn't shrink on mobile */
  .flex-shrink-0 {
    min-width: fit-content;
  }

  /* Tablet compact layout */
  @media (min-width: 640px) and (max-width: 767px) {
    nav a {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
      font-size: 0.8125rem;
    }
  }

  /* Prevent horizontal scrolling on mobile */
  @media (max-width: 639px) {
    body {
      overflow-x: hidden;
    }
  }

  /* Optimize mobile touch feedback */
  @media (max-width: 639px) {
    button, a, [role="button"] {
      -webkit-tap-highlight-color: transparent;
    }
  }

  /* Menu background on small screens */
  @media (max-width: 639px) {
    #mobileMenuBackground {
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }

    #mobileMenuBackground:not(.hidden) {
      opacity: 1;
    }
  }

  /* Ensure mobile menu has good shadow */
  @media (max-width: 639px) {
    #menu > div > div {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
                  0 8px 10px -6px rgba(0, 0, 0, 0.05);
    }

    .dark #menu > div > div {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3),
                  0 8px 10px -6px rgba(0, 0, 0, 0.2);
    }
  }
</style>