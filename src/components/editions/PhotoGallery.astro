---
import { getImage } from "astro:assets";
import fs from "node:fs/promises";
import path from "node:path";
import sharp from "sharp";

interface Props {
  photos: string[];
  altPrefix?: string;
  previewTitle?: string;
  closeLabel?: string;
  viewPhotoLabelPrefix?: string;
  prevLabel?: string;
  nextLabel?: string;
}

const {
  photos,
  altPrefix = "Photo",
  previewTitle = "Aperçu",
  closeLabel = "Fermer",
  viewPhotoLabelPrefix = "Voir la photo",
  prevLabel = "Précédent",
  nextLabel = "Suivant",
} = Astro.props;
const galleryId = `gallery-${Math.random().toString(36).slice(2)}`;

async function getLocalImageDimensions(src: string): Promise<{ width: number; height: number } | null> {
  // Only handle site-local absolute paths like `/uploads/...` living in `public/`.
  if (!src.startsWith("/") || src.startsWith("//") || src.includes("://")) return null;
  const fsPath = path.join(process.cwd(), "public", src);
  try {
    await fs.access(fsPath);
    const meta = await sharp(fsPath).metadata();
    if (meta.width && meta.height) return { width: meta.width, height: meta.height };
  } catch {
    // ignore
  }
  return null;
}

// For CMS/public string URLs (e.g. `/uploads/...`), Astro's Cloudflare image service can still
// generate optimized variants at runtime in production.
const sourceDimensions = await Promise.all(photos.map(getLocalImageDimensions));

const thumbnailImages = await Promise.all(
  photos.map((src) =>
    getImage({
      src,
      width: 400,
      height: 300,
      fit: "cover",
      format: "webp",
      quality: 55,
      densities: [1, 2],
    }),
  ),
);

const lightboxImages = await Promise.all(
  photos.map(async (src, idx) => {
    const dim = sourceDimensions[idx];
    if (dim) {
      const targetWidth = Math.min(1600, dim.width);
      const targetHeight = Math.round((dim.height * targetWidth) / dim.width);
      return getImage({
        src,
        width: targetWidth,
        height: targetHeight,
        fit: "contain",
        format: "webp",
        quality: 80,
      });
    }

    // Remote/unknown images must provide dimensions; `inferSize` will fetch metadata.
    return getImage({
      src,
      width: 1600,
      inferSize: true,
      fit: "contain",
      format: "webp",
      quality: 80,
    });
  }),
);

const lightboxPayload = lightboxImages.map((img, idx) => ({
  // Use the thumbnail as an instant placeholder while the large image loads.
  thumbSrc: thumbnailImages[idx]?.src,
  src: img.src,
}));
---

{photos.length === 0 ? null : (
  <>
    <div class="mt-5 grid grid-cols-2 sm:grid-cols-3 gap-3" data-gallery-root={galleryId}>
      {photos.map((src, idx) => {
        // Load first 6 images eagerly, rest lazily with low priority
        const isAboveFold = idx < 6;
        const thumb = thumbnailImages[idx];
        return (
          <button
            type="button"
            class="group overflow-hidden rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white/60 dark:bg-neutral-950/20 text-left cursor-pointer relative"
            data-photo={src}
            data-index={idx}
            aria-label={`${viewPhotoLabelPrefix} ${idx + 1}`}
          >
            <img
              src={thumb?.src ?? src}
              srcset={thumb?.srcSet?.attribute}
              alt={`${altPrefix} ${idx + 1}`}
              class="w-full h-full object-cover aspect-[4/3] group-hover:scale-[1.03] transition-transform duration-300"
              loading={isAboveFold ? "eager" : "lazy"}
              decoding="async"
              fetchpriority={isAboveFold ? "high" : "low"}
              width="400"
              height="300"
              sizes="(max-width: 640px) 50vw, 33vw"
            />
            {/* Subtle loading placeholder */}
            <div class="absolute inset-0 bg-gradient-to-br from-neutral-100/50 to-neutral-200/30 dark:from-neutral-800/30 dark:to-neutral-900/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none" />
          </button>
        );
      })}
    </div>

    <dialog class="atc-lightbox" data-gallery-dialog={galleryId}>
      <div class="atc-lightbox-container">
        <div class="atc-lightbox-header">
          <span class="atc-lightbox-counter" data-counter></span>
          <button type="button" class="atc-lightbox-close" aria-label={closeLabel}>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="atc-lightbox-content">
          <button type="button" class="atc-lightbox-nav atc-lightbox-prev" aria-label={prevLabel} data-nav="prev">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <div class="atc-lightbox-image-wrapper">
            <img
              alt={previewTitle}
              class="atc-lightbox-image"
              data-lightbox-img
              decoding="async"
              loading="eager"
              sizes="100vw"
            />
          </div>
          <button type="button" class="atc-lightbox-nav atc-lightbox-next" aria-label={nextLabel} data-nav="next">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    </dialog>

    <script is:inline define:vars={{ galleryId, photos: lightboxPayload, altPrefix }}>
      (() => {
        const root = document.querySelector(`[data-gallery-root="${galleryId}"]`);
        const dialog = document.querySelector(`[data-gallery-dialog="${galleryId}"]`);
        const dialogImg = dialog?.querySelector("[data-lightbox-img]");
        const counter = dialog?.querySelector("[data-counter]");
        const prevBtn = dialog?.querySelector("[data-nav='prev']");
        const nextBtn = dialog?.querySelector("[data-nav='next']");
        const closeBtn = dialog?.querySelector(".atc-lightbox-close");
        
        if (!root || !dialog || !dialogImg) return;

        let currentIndex = 0;
        const totalPhotos = photos.length;

        function preload(url) {
          if (!url) return;
          const img = new Image();
          img.decoding = "async";
          img.src = url;
        }

        function updateImage(index) {
          if (index < 0 || index >= totalPhotos) return;
          currentIndex = index;
          const item = photos[index] || {};
          
          // Show loading state
          dialogImg.style.opacity = "0.5";

          // Instant placeholder (thumbnail)
          if (item.thumbSrc) {
            dialogImg.setAttribute("src", item.thumbSrc);
          }

          // Preload large image, then swap in
          const img = new Image();
          img.onload = () => {
            if (item.src) dialogImg.setAttribute("src", item.src);
            dialogImg.setAttribute("alt", `${altPrefix} ${index + 1}`);
            dialogImg.style.opacity = "1";
          };
          img.onerror = () => {
            dialogImg.style.opacity = "1";
            console.warn("Failed to load image:", item.src || item.thumbSrc);
          };
          img.src = item.src || item.thumbSrc || "";

          // Prefetch neighbors for smoother navigation
          const next = photos[index + 1];
          const prev = photos[index - 1];
          preload(next?.src);
          preload(prev?.src);
          
          if (counter) {
            counter.textContent = `${index + 1} / ${totalPhotos}`;
          }
          
          // Update button states
          if (prevBtn) {
            prevBtn.classList.toggle("atc-lightbox-nav-disabled", index === 0);
            prevBtn.setAttribute("aria-disabled", String(index === 0));
          }
          if (nextBtn) {
            nextBtn.classList.toggle("atc-lightbox-nav-disabled", index === totalPhotos - 1);
            nextBtn.setAttribute("aria-disabled", String(index === totalPhotos - 1));
          }
        }

        function showImage(index) {
          updateImage(index);
          dialog.showModal();
          const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
          document.body.style.paddingRight = `${scrollbarWidth}px`;
          document.body.style.overflow = "hidden";
          document.documentElement.style.overflow = "hidden";
        }

        function closeLightbox() {
          dialog.close();
          document.body.style.overflow = "";
          document.documentElement.style.overflow = "";
          document.body.style.paddingRight = "";
        }

        // Open lightbox on thumbnail click
        root.addEventListener("click", (e) => {
          const btn = e.target instanceof Element ? e.target.closest("button[data-photo]") : null;
          if (!btn) return;
          const index = parseInt(btn.getAttribute("data-index") || "0", 10);
          showImage(index);
        });

        // Navigation
        if (prevBtn) {
          prevBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (currentIndex > 0) {
              updateImage(currentIndex - 1);
            }
          });
        }

        if (nextBtn) {
          nextBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (currentIndex < totalPhotos - 1) {
              updateImage(currentIndex + 1);
            }
          });
        }

        // Close button
        if (closeBtn) {
          closeBtn.addEventListener("click", closeLightbox);
        }

        // Close on backdrop click
        dialog.addEventListener("click", (e) => {
          if (e.target === dialog) closeLightbox();
        });

        // Keyboard navigation
        dialog.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            closeLightbox();
          } else if (e.key === "ArrowLeft" && currentIndex > 0) {
            updateImage(currentIndex - 1);
          } else if (e.key === "ArrowRight" && currentIndex < totalPhotos - 1) {
            updateImage(currentIndex + 1);
          }
        });

        // Close on dialog close event
        dialog.addEventListener("close", () => {
          document.body.style.overflow = "";
        });
      })();
    </script>
  </>
)}

<style>
  dialog.atc-lightbox {
    margin: 0;
    padding: 0;
    max-width: 100vw;
    max-height: 100vh;
    width: 100vw;
    height: 100vh;
    border: none;
    background: transparent;
    z-index: 9999;
    overflow: hidden;
  }

  dialog.atc-lightbox::backdrop {
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(4px);
  }

  .atc-lightbox-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.95);
  }

  .atc-lightbox-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .atc-lightbox-counter {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .atc-lightbox-close {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    padding: 0.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .atc-lightbox-close:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .atc-lightbox-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    padding: 2rem;
    gap: 1rem;
  }

  .atc-lightbox-image-wrapper {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    height: 100%;
    width: 100%;
    min-width: 0;
    min-height: 0;
    overflow: hidden;
  }

  .atc-lightbox-image {
    position: absolute;
    inset: 0;
    margin: auto;
    max-width: none;
    max-height: none;
    width: 100%;
    height: 100%;
    object-fit: contain !important;
    border-radius: 0.5rem;
    display: block;
    transition: opacity 0.2s ease-in-out;
  }

  .atc-lightbox-nav {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    padding: 1rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    width: 48px;
    height: 48px;
    flex-shrink: 0;
  }

  .atc-lightbox-nav:hover:not(.atc-lightbox-nav-disabled) {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  .atc-lightbox-nav:active:not(.atc-lightbox-nav-disabled) {
    transform: scale(0.95);
  }

  .atc-lightbox-nav-disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  @media (min-width: 1920px) {
    .atc-lightbox-image-wrapper {
      max-width: calc(100vw - 300px);
      max-height: calc(100vh - 140px);
    }
  }

  @media (max-width: 640px) {
    .atc-lightbox-content {
      padding: 1rem;
      gap: 0.5rem;
    }

    .atc-lightbox-image-wrapper {
      max-width: calc(100vw - 120px);
    }

    .atc-lightbox-nav {
      width: 40px;
      height: 40px;
      padding: 0.75rem;
    }
  }
</style>


